name: Reusable PlatformIO Firmware Release

on:
  workflow_call:
    inputs:
      environment_name:
        description: 'PlatformIO environment name to build (from platformio.ini)'
        required: true
        type: string
      artifact_prefix:
        description: 'Prefix for release artifact filenames'
        required: true
        type: string
      release_body:
        description: 'Markdown content for the release body'
        required: false
        type: string
        default: |
          ## Firmware Release
          
          Built with PlatformIO for embedded devices.
      python_version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      include_elf:
        description: 'Include ELF file in release'
        required: false
        type: boolean
        default: true
      draft:
        description: 'Create release as draft'
        required: false
        type: boolean
        default: false
      prerelease:
        description: 'Mark release as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio
      
      - name: Build firmware
        run: pio run -e ${{ inputs.environment_name }}
      
      - name: Get tag name
        id: tag_name
        run: echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Prepare release artifacts
        run: |
          mkdir -p release
          cp .pio/build/${{ inputs.environment_name }}/firmware.bin release/${{ inputs.artifact_prefix }}-${{ steps.tag_name.outputs.TAG }}.bin
          if [ "${{ inputs.include_elf }}" == "true" ] && [ -f .pio/build/${{ inputs.environment_name }}/firmware.elf ]; then
            cp .pio/build/${{ inputs.environment_name }}/firmware.elf release/${{ inputs.artifact_prefix }}-${{ steps.tag_name.outputs.TAG }}.elf
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body: ${{ inputs.release_body }}
          draft: ${{ inputs.draft }}
          prerelease: ${{ inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
